/* deno-fmt-ignore */ import {drawBorder, indentWrap, colonAttr, isAttribute, createMatcher, maybe, getSeasonAndYear, a4, Tally2, push3, inferLanguage, groupByFunc, errorProof, attempt, maybeLog, insertBeforeIndex, brackets, quote, assert3, strfmt, strReduce, recursivelyDeletePropertyFields, looksLikeHtml, Store2, alignNestedArray, removeDuplicates, asyncMap, txv, splitTwice, lorem, mapkv, resolveObject, inside, splitOnceReverse, getTestData, fooga, denoDebug, denobug, isAbsolutePath, templater3, splitInHalf, pop4, map4, AbstractVisitor, shellEscape, getkv, toggleBooleanState, numbered, noidea, assertObjectValue, assertValue, getClasses, exit, choose, getFileName, testEqual, pause, getBindingValueString, templater2, smartDedent5, pop3, moduleExports, joinPath, expandPath, isDecimal, hasPercentage, ass, parsePercentage, Matrix, isInteger, isEquation, isObjectObject, getExtraIndent, shellUnescape, assertEqual, asyncToggle, touched, chosen, lastOf, firstOf, isBlockEnter, group3, loremIpsum, exportString, deepToggle, maybeNewlineIndent, onAndOff, flattenModule, isModule, isNativeHtmlTag, partitionByValues, strcall, getLongest2, must, mconfig, unreachable, notify, storager, joiner, removeVeryStartingComments, ireplace, removeCommentsInPlace, editf, getLineTokens, IndexedStore, abstractError, bool, xassert, getSetLines, inMiddle, replaceLast, ensureExtension, multipleReplacer, getGradeLevel, constructEdit, getYear, Modulus, wrapClassMethods, proseReplacer, parseComments, parseFunctionDictComments, todo, dictAssertion, boundModularIncrement, construct, reduceToString2, pageTurner, assignCumulative, defaultMergeStrategy, dictSetter3, toArguments, reTemplate, parseFrontmatter, typeAssertion, defineGetter, assignAllowed, simpleRecursiveWalk, simpleArgument, exprTemplater, stringifyIfNotPrimitive, panic, stringerf, wrapFunction, regexTemplater, iso8601, strftime, walkChildEntries, getFiletype, matchf, isUrl, looksLikeFunction, toArgument2, notNull, CumulativeStorage2, simpleAssign, findAndMatch, infuseObjectArray, regexGetter, splitArg, isJavascriptComment, runTest, everyOther, splitByRange, get_regex, getImports, isJavascriptFile, isValidDateString, WriteObject, equalityf, group2, splitOnce2, dedent4, isLowerCase, looksLikeRegExpString, isRegExpString, getDependencies, camelSplit, toggle3, countf, isLiteralObject, bindMethodsAndState2, call, mget3, looks_like_object_function, create_functions_from_master, toStringArgumentPretty, codeChunks, smart_map, run_tests, hasStartingCallable, mapTemplate, aliaser, fixSelector, htmlTags, removePythonComments, simpleStringBreaker, colonConfig, operations, error, redColon, so2, group, parseSingleLineJson, Items, findDependencies, tryf, find4, localeString, cssComment, colonConfigf, trimArray, parseCallable, bringToLifeTextFix, localBringToLife, getCaller4, getErrorStack, forEach, getBindings, getExports, matchstr, filter4, allEqual, count, isNativeFunction, repeat, eat, getIndentAndText, StopWatch, stringDictSetter, getFunctionInfo, runRef, toLines, hasCallable, getProseWords, tally, paramify, codeSplit, debugConfig, logConfig, blueColon, toStringArgument3, stringCallable, simpleBinding, dashSplit4, appendBelow, appendAbove, removeLineComments, prependIfNecessary, smartDedent4, blueSandwich, walk4, findLineIndex, parseAB, applyTransform, kebabCase, getExcerpt, sortObject, buildFunction, maybeSort, parseFunction, isTypable, frontMatter, dictEntry, insertAfterIndex, State, bindMethods, cpop, tagRE, toggle2, createFunction2, assignIncrementedIndex, ufa, assignArray, regexFromComment, createParsersFromObject, imatch, globalConsoleDebug, bindMethodsAndState, isQuestion, oxfordComma, isUpperCase, getFunctionIdentifier, filter3, match, getMatch, alternatef, reCombine, assertion2, deepEqual, hasDollar, so, deepAssign, Tally, getFunctionNames, throwError, notEqual, tryString, prettyPrintCodeSnippet, prettyPrintErrorStack, iter, quotify, transformerf, assign, defineBinding, jspy, linebreak, stringCall2, reduce3, getClassParameters, assignOnTop2, isIdentifier, ndy, dashSplit3, runFunctionFromRef, equalf, alphabet, stateGetterFromSchema, mreplace, require, topLineComment, isChinese, replacef, ignoref, codeLibrary, splitLines, addArgumentQuotes, getBindings2, addCaret, mget2, getStartingConfig, incrementalEat, strlen, hr, setOnce, unescapeHtml, oxford, breakerf, runTests, map3, dateSplit, transformDict, walk3, toRegExp, tryAgainf, assertNotNull, getArgumentObject, isArgumentObject, typef, requireArg, keyAndValue, assignf, stateGetter3, objectFromArguments2, assignDefaults, transformValue, assign3, assignFresh3, evaluate3, scopedEvaluator, objectFromArguments, enforce, sub, filterObject, extractStartingJsonLikeConfig, unbrackify, newlineIndent2, deleteLine, both, normalizeIndent, getComment, secondComment, isStringRegExp, dashSplit2, clock, warning, errorStringify, alert, labelCase, bottomComment, stringCompose, getAnyIdentifier, chalkf, getNumbers, partitions, has, addUnit, toCallable, unquote, filter2, warn2, join2, caller2, assignOnce, longShort, shortLong, argPop, caller, assignOnTop, toggle, defineWindow, unescapeNewlines, escapeQuotes, unescapeQuotes, escapeNewlines, setAliases, announceCaller, removeStartingComments, smartBind, assignExisting, isObjectWithKey, eatStart, modularIncrementItem, getRegex, runFunction, isObjectLikeArray, itemGetter2, getAllKeys, prefixSlice, hasQuotes, assertion, diff, toggleState, initState, dunder, objectGetter, superTransform, popFilter, testRunner, assert2, insertAtDollar, popEmptyLine, getOptions, mergeSpecs, sortByKeys, map2, strictMessengerAssert, smartSplit, chalk4, typeLog, getFunctionName, Clock, search3, MyError, fuzzyMatch3, debugDisplay, getCaller3, messengerAssert, camelSlice, setPrototype, assignAliases, display, modifyNumber, toDict, setPush, modularIncrementIndex, longstamp, popIndex, toggleOnOff, locWrap, walk2, typeMatch, prettyStringify, getIdentifiers, CustomError, argMatch, brackify2, smartestDedent, modularIncrementNumber, AbstractMethodError, allUnique, Trie, boundarySplit, numberBoundarySplit, nodeLog, getFirst, defineProperty, supermix, partial, timeLog, timestamp, raise, getIdentifier, conditionalPrefix, conditionalSuffix, QueryList, fuzzyMatch2, buildDict, getTextAndCommand, sprawlFactory, getParameters2, pushf, intersection, union, blue, green, sandwich, getLastSpaces, smartDedent3, red, sort, debounce, checkValue, getCodeChunks, logf, boundary, myError, conditional, isStringFunction, toSpaces, objectf, searchAll, difference, singleQuote, itemGetter, slice2, mergeObjects, once, dashSplit, nchalk, coerceToObject, ArrayState, exporter2, indent2, iterator, removeAllComments, countParams, cumulativeSchemaAssign, argKwargSplit, argParse, removeInlineComments, getFrontMatter, hasHtmlSuffix, lazyArray, isThisFunction, escapeHTML, getKwargs2, search2, toStringArgument, createFuzzyMatch, edit2, splice, zip, merge2, argArgsKwargs, fill2, chalk, vueWrap, splitArray, splitArray2, warn, makeRunner2, searchf2, smartDedent2, dedent2, toArray2, stateGetter2, sortByIndex, IndexedCache, argo, curry2, doUntil2, evaluate2, findall2, findIndex2, findItem2, getCaller2, getErrorStack2, isJson, indexGetter2, insert2, pop2, parseError2, remove2, reduce2, testf2, type2, unshift2, waterfall2, xsplit2, Cache, cumulativeAssign, replaceBefore, topComment, isAsyncFunction, mapSort, getFileURI, getQuotes, isClassObject, isInitialized, getFallback, bindingRE, addObjectOrObjectProperty, forDoubles, isCss, log, iterate, backAndForth, round, iteratorWrapper, toJSON, isFromMap, toString, empty, conditionalString, getConfigArg, hasKey, errorWrap, successWrap, check, toPoints, bind, mixinAliases, isPercentage, isBasicType, reducerStrategy, gather, entries, stateGetter, methodCase, vueCase, push2, smarterIndent, lineSplit, Store, isSingleLetter, prepareText, isSymbol, getShortest, slice, KeyError, deepCopy, argsKwargs, isError, isColor, list, objectEditor, matchall, makeFastRunner, announce, hasLetter, filter, reduce, stringCall, capitalizeName, stop, proseCase, lineDitto, mixinSetters, modularIncrement, distinct, definedSort, groupBy, reWrap2, fuzzyMatch, isPlural, Element, parseError, isPrimitiveArray, callableArgsKwargs, waterfall, defineVariable, info, flat2D, splitThePage, handleError, dedent, TypeAssertion, createFunction, pluralize, remove, Group, PageStorage, Storage, UniqueStorage, Watcher, arrayToDict, addProperty, addQuotes, argWrapFactory, assert, abrev, abf, addExtension, assignFresh, antif, atFirst, atSecond, backspace, bindObject, breaker, blockQuote, brackify, bringToLife, comment, countCaptureGroups, capitalizeTitle, classMixin, callableRE, camelToTitle, curry, createVariable, changeExtension, curryStart, curryEnd, capitalize, copy, camelCase, compose, char2n, camelToDash, deepMerge, datestamp, doublef, dictSetter, dictSetter2, dsearch, doUntil, dashCase, doubleQuote, dict, dictGetter, depluralize, dreplace, dictf, endsWithWord, exporter, edit, exists, evaluate, extend, find, flatMap, fill, fixUrl, functionGetter, findall, fixPath, flat, fparse, findIndex, firstLine, ftest, getKwargs, getFirstName, getBindingName, getParameters, getLastWord, getCodeWords, getCodeWords2, getIndent, getExtension, getLast, getLongest, getChunks, getCaller, getStackTrace, getConstructorName, getFirstWord, getWords, getSpaces, hasComma, hasSpaces, hasHtml, hasBracket, hasNewline, hasCaptureGroup, hasEquals, hasValue, hasCamelCase, hasNumber, hackReplace, insert, indexGetter, incrementf, isCallable, isQuote, isEven, isOdd, isLast, isHTML, isNode, interweave, inferLang, isString, isArray, isObject, isDefined, isFunction, isPrimitive, isNumber, isSet, isNestedArray, indent, isNull, isWord, isBoolean, isRegExp, identity, isObjectLiteral, isJsonParsable, isCapitalized, isNewLine, isObjectArray, isStringArray, isClassFunction, joinSpaces, join, keyArrayToObject, lowerCase, linebreakRE, len, lineGetter, lineCount, lastLine, logConsole, makeRunner, mixin, modularf, matchGetter, merge, mget, map, mergeOnTop, mergeToObject, mapFilter, noop, nestPush, no, newlineIndent, n2char, objectWalk, overlap, objectToString, opposite, pipe, parseTopAttrs, pascalCase, partition, parens, push, pop, parseJSON, rigidSort, removeQuotes, rep, removeComments, range, removeExtension, rescape, reverse, reWrap, reduceToString, repeatUntil, swapKey, sayhi, swap, splitMapJoin, splitCamel, smallify, search, stringify, shared, smartDedent, stringBreaker, sleep, split, snakeCase, stringArgument, sorted, splitOnce, searchf, secondLine, titleCase, textOrJson, toNumber, toArgument, toNestedArray, test, type, tail, transformObject, trim, testf, toArray, templater, totalOverlap, upperCase, unique, uncapitalize, unzip, wrap, walk, wrapf, xsplit, yes, zip2} from "/home/kdog3682/2023/utils.js"
import { doString } from "/home/kdog3682/2024-javascript/ttt/doString.js"
import { doJson } from "/home/kdog3682/2024-javascript/ttt/doJson.js"
// import { doFoobar } from "/home/kdog3682/2024-javascript/ttt/doFoobar.js"
import { doFrontmatter } from "/home/kdog3682/2024-javascript/ttt/doFrontmatter.js"
import { createRoot } from "/home/kdog3682/2024-javascript/ttt/createRoot.js"
function demo(node) {

}
function foobar(node) {
    if (node.isLeaf()) {
        return {
            text: node.text,
            ind: node.ind,
            newlines: node.newlines,
        }
    }
}
function accumulateText(node) {
    const offset = node.ind
    const get = (node) => {
        const ind = node.ind - offset
        const newlines = 1
        return " ".repeat(ind * 4) + node.text +
            "\n".repeat(node.newlines + newlines)
    }
    const callback = (child, i, a) => {
        newlines = child.newlines
        if (child.isBranch()) {
            return get(child) + runner(child)
        } else {
            return get(child)
        }
    }
    const runner = (node) => {
        return node.children.map(callback).join("")
    }

    let newlines
    let ind = node.ind
    const text = callback(node).trimEnd()
    // throw drawBorder(text)
    return {
        text,
        newlines,
        ind,
    }
}
class State3 {
    constructor(opts = {}) {
        this.attrs = {}
        this.children = []
        this.opts = opts
    }
    addAttributes(o) {
        Object.assign(this.attrs, o)
    }
    toJSON() {
        return {
            attrs: this.attrs,
            children: this.children,
        }
    }
}

function applyComponentCallbackToNode(node, callback) {
    return runner(node)

    function runner(node) {
        let touchedText = false
        const state = new State3()

        for (let i = 0; i < node.children.length; i++) {
            const child = node.children[i]
            if (child.touched) {
                continue
            }
            if (!touchedText && isAttribute(child.text)) {
                state.addAttributes(doFrontmatter(child))
            } else {
                touchedText = true
                const value = callback(child) || visit(child) || accumulateText(child)
                assert(value, "a result must be generated")
                state.children.push(value)
            }
        }
        return state.toJSON()
    }
}

const baseConfigs = [
    {
        name: "root",
        test: {
            branch: true,
            uid: 0,
        },
        callback: onRoot,
    },

    {
        name: "frontmatter",
        test: {
            branch: true,
            name: true,
        },
        callback: onFrontmatter,
    },

    {
        name: "component",
        test: {
            branch: true,
        },
        components: {
            foobar,
            demo,
        }
    },
]

function onFrontmatter(node) {
    throw doFrontmatter(node)
    if (!node.text) {
        return node.text
    }
    throw "hi"
}

function aggregate(value) {
    return value
}

function applyChildren(node, configs) {
    const value = node.children.map((child, i) => {
        return apply(child, configs)
    })
    return aggregate(value)
}
function onRoot(node) {
    return applyChildren(node)
}

function apply(node, configs) {
    if (configs == null) {
        configs = baseConfigs
    }

    for (const config of configs) {
        const { name, uid, branch, regex, targets } = config.test
        if (branch && !node.isBranch()) {
            continue
        }
        if (isDefined(uid) && !node.uid == uid) {
            continue
        }

        if (regex && !regex.test(node.text)) {
            continue
        }

        if (name && config.name != node.text) {
            continue
        }

        if (targets && !targets.includes(node.text)) {
            continue
        }

        if (config.components && node.text in config.components) {
            const key = node.text
            const callback = config.components[key]
            const value = applyComponentCallbackToNode(node, callback)
            value.key = key
            return value
        } else if (config.callback) {
            return config.callback(node)
        }
    }
}

function visit(x) {
    return apply(createRoot(x))
}

const componentStr = `

foobar
    dd: foolio
    bb: argard

    lets go
    this is prose

    foobar 
        asdf: 1
        iiasdf: 
            sd:
                sd:
                    sd: 1

        hi there
        hi there
        hi there
    
    barrkre3
    barrkre1
        barrkre2

        aaaa
            aaa
                aaa
                aaa
            aaab
        aaab
        foobar
            asd: 1 this is part of text

    foobar
        asd: 1
`
const componentStr2 = `

    foobar
        asd: 1

        hi from 1
        foobar
            asd: 12

            hi from 12
            foobar
                asd: 123

                hi from 123
`
console.log(stringify(visit(smartDedent(removeComments(componentStr2)))))
